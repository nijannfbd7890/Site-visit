<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Team Wise WRM Achieved (%) Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body{font-family:Poppins;background:#f4f6f9;margin:0}
.header{background:#1f3c88;color:#fff;padding:25px;text-align:center}
.container{padding:20px}
.filters{display:flex;justify-content:center;gap:10px;margin:20px}
.filters input,.filters button{padding:8px 12px;border-radius:6px;border:1px solid #ccc}
.filters button{background:#1f3c88;color:#fff;cursor:pointer}
.summary{display:flex;gap:20px;justify-content:center;margin-bottom:20px}
.box{background:#fff;padding:10px 20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
thead th{background:#f4b400}
tbody tr:nth-child(even){background:#e3f2fd}
tbody tr:nth-child(odd){background:#fff8e1}
tfoot tr{background:#fdd835;font-weight:bold}
</style>
</head>

<body>

<div class="header">
  <h1>Team Wise WRM Achieved (%) Report</h1>
  <h3>Namma Family Builder and Developer Pvt. Ltd</h3>
  <p>Team - Marketing Management</p>
</div>

<div class="container">

<div class="filters">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button onclick="applyFilter()">Apply Filter</button>
</div>

<div class="summary">
  <div class="box">Total Site Visits: <b id="svTotal">0</b></div>
  <div class="box">Below 8: <b id="svBelow">0</b></div>
  <div class="box">Above 8: <b id="svAbove">0</b></div>
  <div class="box">Booking Count: <b id="bkCount">0</b></div>
  <div class="box">Total Sqft: <b id="bkSqft">0</b></div>
</div>

<table>
<thead>
<tr>
  <th rowspan="2">S.No</th>
  <th rowspan="2">Team Name</th>
  <th colspan="3">Site Visit</th>
  <th rowspan="2">Target Sq.ft</th>
  <th colspan="3">Overall Booking</th>
</tr>
<tr>
  <th>Below 8</th>
  <th>Above 8</th>
  <th>Total</th>
  <th>Count</th>
  <th>Sqft</th>
  <th>%</th>
</tr>
</thead>
<tbody></tbody>
<tfoot></tfoot>
</table>

</div>

<script>
const CSV_BOOKING="https://nijannfbd7890.github.io/Site-visit/workbook.csv";
const CSV_VISIT="https://nijannfbd7890.github.io/Site-visit/SITE_VISIT.csv";

const TEAMS=[
 "Ranjith Sir","Suriya Sir & Selvakumar Sir","Latha Mam & Ayyappan Sir",
 "Prabhakaran Sir","Ashok Sir","Rajiv Sir","Gopi Sir",
 "Thangadurai Sir","Senthil Sir","Kumaresan Sir","Sankar Sir"
];

const TARGET={
 "Ranjith Sir":16500,"Suriya Sir & Selvakumar Sir":15600,
 "Latha Mam & Ayyappan Sir":17400,"Prabhakaran Sir":7300,
 "Ashok Sir":15100,"Rajiv Sir":10100,"Gopi Sir":3000,
 "Thangadurai Sir":17100,"Senthil Sir":8500,
 "Kumaresan Sir":5700,"Sankar Sir":5100
};

const visitMap={
 "mr ranjith sir":"Ranjith Sir",
 "mr suriya sir & mr selvakumar sir":"Suriya Sir & Selvakumar Sir",
 "mr ayyappan sir & mrs latha mam":"Latha Mam & Ayyappan Sir",
 "mr prabhakaran sir":"Prabhakaran Sir",
 "mr ashok sir":"Ashok Sir",
 "mr rajiv sir":"Rajiv Sir",
 "mr gopi sir":"Gopi Sir",
 "mr thangadurai sir":"Thangadurai Sir",
 "mr senthil sir":"Senthil Sir",
 "mr ak kumaresan sir":"Kumaresan Sir",
 "mr sankar sir":"Sankar Sir"
};

function norm(v){
 return (v||"").toLowerCase().replace(/\./g," ").replace(/\s+/g," ")
 .split("&").map(x=>x.trim()).sort().join(" & ");
}

const visitNorm={};
Object.keys(visitMap).forEach(k=>visitNorm[norm(k)]=visitMap[k]);

function parseVisitDate(d){
function parseVisitDate(d){
 if(!d) return null;

 d = d.toString().replace(/\uFEFF/g,"").trim();

 // remove time part if present
 d = d.split(" ")[0];

 let parts, day, month, year;

 // yyyy-mm-dd
 if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
   parts = d.split("-");
   year  = +parts[0];
   month = +parts[1] - 1;
   day   = +parts[2];
 }
 // dd-mm-yyyy OR dd/mm/yyyy
 else if (/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(d)) {
   parts = d.includes("/") ? d.split("/") : d.split("-");
   day   = +parts[0];
   month = +parts[1] - 1;
   year  = +parts[2];
 }
 else {
   return null;
 }

 const dt = new Date(year, month, day);
 return isNaN(dt.getTime()) ? null : dt;
}






function normalizePickerDate(v){
 if(!v) return null;
 const [y,m,d]=v.split("-");
 return new Date(y,m-1,d);
}

let bookingRows=[],visitRows=[];
Papa.parse(CSV_BOOKING,{download:true,header:true,complete:r=>{
 bookingRows=r.data;
 Papa.parse(CSV_VISIT,{download:true,header:true,complete:v=>{
  visitRows=v.data; applyFilter();
 }});
}});

function applyFilter(){
 const fromD=normalizePickerDate(fromDate.value);
 const toD=normalizePickerDate(toDate.value);
 if(toD) toD.setHours(23,59,59,999);

 const visitAgg={},bookAgg={};
 TEAMS.forEach(t=>{
  visitAgg[t]={below:0,above:0,total:0};
  bookAgg[t]={count:0,sqft:0};
 });
 visitAgg.__all={below:0,above:0,total:0};

 bookingRows.forEach(r=>{
  const d=parseVisitDate(r["BOOKING DATE"]);
  if(fromD && d<fromD) return;
  if(toD && d>toD) return;
  const team=TEAMS.find(t=>(r["TEAM NAME"]||"").toLowerCase().includes(t.toLowerCase()));
  if(!team) return;
  bookAgg[team].count++;
  bookAgg[team].sqft+=+r["Actual TOTAL SQ-FT"]||0;
 });

 visitRows.forEach(r=>{
  const d=parseVisitDate(r["DATE"]||r["\ufeffDATE"]);
  if(!d) return;
  if(fromD && d<fromD) return;
  if(toD && d>toD) return;

  const team=visitNorm[norm(r["TEAM NAME"])];
  const type=(r["Above /below"]||"").toLowerCase();

  visitAgg.__all.total++;
  if(type.includes("below")) visitAgg.__all.below++;
  if(type.includes("above")) visitAgg.__all.above++;

  if(!team) return;
  visitAgg[team].total++;
  if(type.includes("below")) visitAgg[team].below++;
  if(type.includes("above")) visitAgg[team].above++;
 });

 render(visitAgg,bookAgg);
 
}

function render(vAgg,bAgg){
 const tb=document.querySelector("tbody");
 const tf=document.querySelector("tfoot");
 tb.innerHTML=""; tf.innerHTML="";
 let i=1,bc=0,bs=0;

 TEAMS.forEach(t=>{
  const v=vAgg[t],b=bAgg[t];
  bc+=b.count; bs+=b.sqft;
  tb.innerHTML+=`
  <tr>
   <td>${i++}</td><td>${t}</td>
   <td>${v.below}</td><td>${v.above}</td><td>${v.total}</td>
   <td>${TARGET[t]}</td>
   <td>${b.count}</td><td>${Math.round(b.sqft)}</td>
   <td>${Math.min(100,Math.round(b.sqft/TARGET[t]*100||0))}%</td>
  </tr>`;
 });

 tf.innerHTML=`
 <tr>
  <td colspan="2">Grand Total</td>
  <td>${vAgg.__all.below}</td>
  <td>${vAgg.__all.above}</td>
  <td>${vAgg.__all.total}</td>
  <td>${Object.values(TARGET).reduce((a,b)=>a+b,0)}</td>
  <td>${bc}</td>
  <td>${Math.round(bs)}</td>
  <td>${Math.min(100,Math.round(bs/Object.values(TARGET).reduce((a,b)=>a+b,0)*100))}%</td>
 </tr>`;

 svTotal.textContent=vAgg.__all.total;
 svBelow.textContent=vAgg.__all.below;
 svAbove.textContent=vAgg.__all.above;
 bkCount.textContent=bc;
 bkSqft.textContent=Math.round(bs);
}
</script>

</body>
</html>
