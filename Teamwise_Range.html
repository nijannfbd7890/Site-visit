<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Teamwise Range - WRM Dashboard</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body {
  background: #f5f6fa;
  font-family: "Poppins", sans-serif;
  color: #222;
  text-align: center;
  margin: 0;
  padding: 0;
}
header {
  width: 100%;
  background: linear-gradient(90deg, #1e3a8a, #22398a);
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 40px;
}
.logo-left, .logo-right {
  height: 60px;
  width: 60px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  border: 2px solid #f5b301;
}
.header-title {
  flex: 1;
  text-align: center;
}
.header-title h1 {
  font-size: 1.8rem;
  line-height: 1.4;
  margin: 0;
  font-weight: 700;
  color: #fff;
}
.header-title span {
  font-size: 1.1rem;
  color: #fdd835;
  font-weight: 600;
}
.main-wrapper {
  max-width: 1200px;
  margin: 25px auto 40px;
  padding: 25px;
  background: #ffffff;
  border-radius: 18px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.05);
}
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 25px;
}
.filter-bar input, .filter-bar button {
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 0.95rem;
}
.filter-bar button {
  background: #1e3a8a;
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 600;
}
.filter-bar button:hover { background: #2a4ed0; }

.summary-row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 25px;
  justify-content: center;
}
.summary-card {
  min-width: 220px;
  padding: 20px 25px;
  border-radius: 14px;
  background: #f9fafb;
  border: 1px solid #e0e0e0;
  text-align: center;
}
.summary-card h3 {
  margin: 0 0 8px;
  font-size: 1rem;
  color: #1e3a8a;
}
.summary-card p {
  margin: 0;
  font-size: 1.4rem;
  font-weight: 600;
  color: #000;
}
.subcounts {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 5px;
}
.subcounts span {
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 6px;
}
.subcounts .below { background: #ffcccc; color: #000; }
.subcounts .above { background: #c9f7c1; color: #000; }

.table-wrapper { overflow-x: auto; margin-top: 20px; }
#staffTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
  color: #000;
  border-radius: 12px;
  overflow: hidden;
}
#staffTable th, #staffTable td {
  border: 1px solid #e0e0e0;
  padding: 8px;
  text-align: center;
}
#staffTable thead tr:first-child th {
  background: #1e3a8a;
  color: #fff;
  font-size: 1rem;
  padding: 10px;
}
#staffTable thead tr:nth-child(2) th {
  background: #f5b301;
  color: #000;
}
#staffTable tbody tr:nth-child(3n+1) { background-color: #fff8e1; }
#staffTable tbody tr:nth-child(3n+2) { background-color: #e3f2fd; }
#staffTable tbody tr:nth-child(3n+3) { background-color: #f1f8e9; }
#staffTable tbody tr:last-child { background-color: #fdd835 !important; font-weight: 700; color: #000; }

.chart-container {
  margin-top: 30px;
  padding: 15px;
  border-radius: 16px;
  background: #ffffff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  height: 400px;
}
.chart-container h3 { margin-bottom: 10px; }
</style>
</head>

<body>
<header>
  <div class="header-container">
    <img src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/LOGO.png" class="logo-left" />
    <div class="header-title">
      <h1>
        Namma Family Builder and Developer Pvt. Ltd<br>
        Site Visit Dashboard<br>
        <span>Team - Marketing Management</span>
      </h1>
    </div>
    <img src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/cs.jpg" class="logo-right" />
  </div>
</header>

<div class="main-wrapper">
  <div class="filter-bar">
    <input type="date" id="startDate" />
    <input type="date" id="endDate" />
    <button onclick="applyFilters()">Apply Filter</button>
  </div>

  <div class="summary-row">
    <div class="summary-card"><h3>Total Site Visits</h3><p id="totalSiteVisits">0</p></div>
    <div class="summary-card"><h3>Total Actual TOTAL SQ-FT</h3><p id="totalSqft">0</p></div>
    <div class="summary-card"><h3>Total Visits (Above/Below)</h3><p id="totalVisits">0</p>
      <div class="subcounts">
        <span class="below">Below 8: <span id="belowCount">0</span></span>
        <span class="above">Above 8: <span id="aboveCount">0</span></span>
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="staffTable">
      <thead>
        <tr><th colspan="10">Team Wise WRM Achieved (%) Report</th></tr>
        <tr>
          <th rowspan="2">S.No</th>
          <th rowspan="2">Team Name</th>
          <th colspan="3">Site Visit</th>
          <th rowspan="2">Target Sq.ft</th>
          <th colspan="3">Overall Booking</th>
        </tr>
        <tr>
          <th>Below 8</th>
          <th>Above 8</th>
          <th>Total</th>
          <th>Count</th>
          <th>Sqft</th>
          <th>% (Percentage)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-container">
    <h3>Actual TOTAL SQ-FT by TEAM NAME</h3>
    <canvas id="teamChart"></canvas>
  </div>
</div>

<footer>© 2025 Namma Family Builder & Developer Pvt. Ltd — All Rights Reserved</footer>

<script>
const CSV_MAIN  = "https://nijannfbd7890.github.io/Site-visit/workbook.csv";
const CSV_VISIT = "https://nijannfbd7890.github.io/Site-visit/SITE_VISIT.csv";

let allMainRows  = [];
let allVisitRows = [];

const teamTargets = {
  "Ashok Sir": 15100,
  "Gopi Sir": 3000,
  "Kumaresan Sir": 5700,
  "Latha Mam & Ayyappan Sir": 17400,
  "Prabhakaran Sir": 7300,
  "Rajiv Sir": 10100,
  "Ranjith Sir": 16500,
  "Sankar Sir": 5100,
  "Senthil Sir": 8500,
  "Suriya Sir & Selvakumar Sir": 15600,
  "Thangadurai Sir": 17100
};

function buildInitialTable() {
  const tbody = document.querySelector("#staffTable tbody");
  tbody.innerHTML = "";
  let sno = 1, totalTarget = 0;
  Object.entries(teamTargets).forEach(([teamName, target]) => {
    totalTarget += target;
    tbody.innerHTML += `
      <tr>
        <td>${sno++}</td>
        <td>${teamName}</td>
        <td>0</td>
        <td>0</td>
        <td>0</td>
        <td>${target}</td>
        <td>0</td>
        <td>0</td>
        <td>0%</td>
      </tr>`;
  });
  tbody.innerHTML += `
    <tr>
      <td colspan="2">Grand Total</td>
      <td>0</td><td>0</td><td>0</td>
      <td>${totalTarget}</td>
      <td>0</td><td>0</td><td>0%</td>
    </tr>`;
}

// ---- Real computation starts only after Apply Filter ----
function buildTeamReport(mainRows, visitRows) {
  const agg = {};
  mainRows.forEach(r => {
    const teamName = r["Team Name"] || r["TEAM NAME"];
    if (!teamName) return;
    const key = teamName.trim();
    if (!agg[key]) agg[key] = { below: 0, above: 0, count: 0, sqft: 0 };
    agg[key].count += parseFloat(r["No of Plots"] || 0);
    agg[key].sqft += parseFloat(r["Actual TOTAL SQ-FT"] || 0);
  });

  visitRows.forEach(r => {
    const teamName = r["Team Name"] || r["TEAM NAME"];
    if (!teamName) return;
    const key = teamName.trim();
    if (!agg[key]) agg[key] = { below: 0, above: 0, count: 0, sqft: 0 };
    const type = String(r["Above/Below"] || r["Above /below"] || "").toLowerCase();
    if (type.includes("below")) agg[key].below++;
    else if (type.includes("above")) agg[key].above++;
  });

  const tbody = document.querySelector("#staffTable tbody");
  tbody.innerHTML = "";
  let sno = 1, tb=0, ta=0, tt=0, tc=0, ts=0, totalTarget=0;
  Object.entries(teamTargets).forEach(([teamName, target]) => {
    const d = agg[teamName] || { below: 0, above: 0, count: 0, sqft: 0 };
    const total = d.below + d.above;
    const pct = target > 0 ? Math.min(((d.sqft / target) * 100), 100).toFixed(0) : 0;
    tb += d.below; ta += d.above; tt += total; tc += d.count; ts += d.sqft; totalTarget += target;
    tbody.innerHTML += `
      <tr>
        <td>${sno++}</td>
        <td>${teamName}</td>
        <td>${d.below}</td>
        <td>${d.above}</td>
        <td>${total}</td>
        <td>${target}</td>
        <td>${d.count}</td>
        <td>${d.sqft}</td>
        <td>${pct}%</td>
      </tr>`;
  });

  const grandPct = totalTarget > 0 ? Math.min((ts / totalTarget) * 100, 100).toFixed(0) : 0;
  tbody.innerHTML += `
    <tr>
      <td colspan="2">Grand Total</td>
      <td>${tb}</td><td>${ta}</td><td>${tt}</td>
      <td>${totalTarget}</td><td>${tc}</td><td>${ts}</td><td>${grandPct}%</td>
    </tr>`;

  document.getElementById("belowCount").textContent = tb;
  document.getElementById("aboveCount").textContent = ta;
  document.getElementById("totalVisits").textContent = tt;
  document.getElementById("totalSiteVisits").textContent = tt;
  document.getElementById("totalSqft").textContent = ts.toFixed(2);
}

// ---- Apply Filter ----
function applyFilters() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if (!start || !end) {
    alert("Please select both start and end dates!");
    return;
  }

  const filter = (rows, dateColNames) => rows.filter(r => {
    const dateStr = r["Date"] || r["SITE VISIT DATE"] || r["Site Visit Date"];
    if (!dateStr) return false;
    const d = new Date(dateStr);
    return d >= new Date(start) && d <= new Date(end);
  });

  const fm = filter(allMainRows, ["Site Visit Date"]);
  const fv = filter(allVisitRows, ["Date"]);
  buildTeamReport(fm, fv);
}

Papa.parse(CSV_MAIN, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: resMain => {
    allMainRows = resMain.data;
    Papa.parse(CSV_VISIT, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: resVisit => {
        allVisitRows = resVisit.data;
        buildInitialTable(); // Only basic data shown initially
      }
    });
  }
});
</script>
</body>
</html>
