<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Teamwise Range - WRM Dashboard</title>

<!-- Script Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body {
  background: #f5f6fa;
  font-family: "Poppins", sans-serif;
  color: #222;
  text-align: center;
  margin: 0;
  padding: 0;
}
header {
  width: 100%;
  background: linear-gradient(90deg, #1e3a8a, #22398a);
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 40px;
}
.logo-left, .logo-right {
  height: 60px;
  width: 60px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  border: 2px solid #f5b301;
}
.header-title {
  flex: 1;
  text-align: center;
}
.header-title h1 {
  font-size: 1.8rem;
  line-height: 1.4;
  margin: 0;
  font-weight: 700;
  color: #fff;
}
.header-title span {
  font-size: 1.1rem;
  color: #fdd835;
  font-weight: 600;
}
.main-wrapper {
  max-width: 1200px;
  margin: 25px auto 40px;
  padding: 25px;
  background: #ffffff;
  border-radius: 18px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.05);
}
.summary-row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 25px;
  justify-content: center;
}
.summary-card {
  min-width: 220px;
  padding: 20px 25px;
  border-radius: 14px;
  background: #f9fafb;
  border: 1px solid #e0e0e0;
  text-align: center;
}
.summary-card h3 {
  margin: 0 0 8px;
  font-size: 1rem;
  color: #1e3a8a;
}
.summary-card p {
  margin: 0;
  font-size: 1.4rem;
  font-weight: 600;
  color: #000;
}
.table-wrapper {
  overflow-x: auto;
  margin-top: 20px;
}
#staffTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
  color: #000;
  border-radius: 12px;
  overflow: hidden;
}
#staffTable th, #staffTable td {
  border: 1px solid #e0e0e0;
  padding: 8px;
  text-align: center;
}
#staffTable thead tr:first-child th {
  background: #1e3a8a;
  color: #fff;
  font-size: 1rem;
  padding: 10px;
}
#staffTable thead tr:nth-child(2) th {
  background: #f5b301;
  color: #000;
}
.chart-container {
  margin-top: 30px;
  padding: 15px;
  border-radius: 16px;
  background: #ffffff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  height: 400px;
}
</style>
</head>

<body>
<header>
  <div class="header-container">
    <img src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/LOGO.png" class="logo-left" />
    <div class="header-title">
      <h1>
        Namma Family Builder and Developer Pvt. Ltd<br>
        Site Visit Dashboard<br>
        <span>Team - Marketing Management</span>
      </h1>
    </div>
    <img src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/cs.jpg" class="logo-right" />
  </div>
</header>

<div class="main-wrapper">
  <div class="summary-row">
    <div class="summary-card">
      <h3>Total Teams</h3>
      <p id="totalTeams">0</p>
    </div>
    <div class="summary-card">
      <h3>Total Actual TOTAL SQ-FT</h3>
      <p id="totalSqft">0</p>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="staffTable">
      <thead>
        <tr>
          <th colspan="11">Team Wise WRM Achieved (%) Report</th>
        </tr>
        <tr>
          <th rowspan="2">S.No</th>
          <th rowspan="2">Team Name</th>
          <th colspan="3">Site Visit</th>
          <th rowspan="2">Target Sq.ft</th>
          <th rowspan="2">Count</th>
          <th rowspan="2">Sqft</th>
          <th rowspan="2">% (Percentage)</th>
          <th rowspan="2">Target Achieved (%)</th>
        </tr>
        <tr>
          <th>Below 8</th>
          <th>Above 8</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-container">
    <h3>Actual TOTAL SQ-FT by TEAM NAME</h3>
    <canvas id="teamChart"></canvas>
  </div>
</div>

<footer>© 2025 Namma Family Builder & Developer Pvt. Ltd — All Rights Reserved</footer>

<script>
const CSV_MAIN = "https://nijannfbd7890.github.io/Site-visit/workbook.csv";
const CSV_VISIT = "https://nijannfbd7890.github.io/Site-visit/SITE_VISIT.csv";

const teamTargets = {
  "Mr.Suriya Sir & Selva Kumar Sir": 15600,
  "Mr.Prabhakaran sir": 7300,
  "Mr.Senthil Sir": 8500,
  "Mr.Ranjith sir": 16500,
  "Mr.Thangadurai Sir": 17100,
  "Mr.Gopi Sir": 3000,
  "Mr.Latha Mam & Ayyappan Sir": 17400,
  "Mr.Rajiv sir": 10100,
  "Mr.Ashok sir": 15100,
  "Mr.Sankar Sir": 5100,
  "Mr.Kumaresan sir": 5700
};

Papa.parse(CSV_MAIN, {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: resultsMain => {
    Papa.parse(CSV_VISIT, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: resultsVisit => buildTeamReport(resultsMain.data, resultsVisit.data),
      error: () => alert("Failed to load SITE_VISIT.csv.")
    });
  },
  error: () => alert("Failed to load workbook.csv.")
});

let teamChartInstance = null;

function buildTeamReport(rowsMain, rowsVisit) {
  if (!rowsMain?.length) return;
  const normalize = s => (s || "").trim().toLowerCase().replace(/\s+/g, '');

  const firstRow = rowsMain[0];
  const keys = Object.keys(firstRow);
  const teamKey = keys.find(k => normalize(k) === "teamname" || normalize(k) === "team name");
  const sqftKey = keys.find(k => normalize(k).startsWith("actualtotalsq-ft"));

  if (!teamKey || !sqftKey) {
    alert("workbook.csv must include TEAM NAME and Actual TOTAL SQ-FT columns");
    return;
  }

  const teamData = {};
  rowsMain.forEach(r => {
    const team = (r[teamKey] || "").trim();
    if (!team) return;
    const sqft = parseFloat((r[sqftKey] || "0").replace(/,/g, "")) || 0;
    if (!teamData[team]) teamData[team] = { sqft: 0, count: 0 };
    teamData[team].sqft += sqft;
    teamData[team].count += 1;
  });

  const visitData = {};
  rowsVisit.forEach(v => {
    const team = (v["TEAM NAME"] || "").trim();
    const category = (v["Above /below"] || "").trim().toLowerCase();
    if (!team) return;
    if (!visitData[team]) visitData[team] = { below: 0, above: 0 };
    if (category.includes("below")) visitData[team].below += 1;
    else if (category.includes("above")) visitData[team].above += 1;
  });

  const entries = Object.entries(teamData).sort((a, b) => b[1].sqft - a[1].sqft);
  const totalSqft = entries.reduce((sum, [, v]) => sum + v.sqft, 0);

  document.getElementById("totalTeams").textContent = entries.length;
  document.getElementById("totalSqft").textContent = Math.round(totalSqft).toLocaleString("en-IN");

  const tbody = document.querySelector("#staffTable tbody");
  tbody.innerHTML = "";

  let totalBelow = 0, totalAbove = 0, totalVisits = 0, totalCount = 0, totalAchievedSum = 0, teamsWithTarget = 0;

  entries.forEach(([team, { sqft, count }], i) => {
    const percent = totalSqft ? (sqft / totalSqft) * 100 : 0;
    totalCount += count;

    const teamClean = normalize(team);
    let target = 0;
    for (const [key, value] of Object.entries(teamTargets)) {
      if (teamClean.includes(normalize(key)) || normalize(key).includes(teamClean)) {
        target = value;
        break;
      }
    }

    let below = 0, above = 0;
    for (const [key, val] of Object.entries(visitData)) {
      if (teamClean.includes(normalize(key)) || normalize(key).includes(teamClean)) {
        below = val.below;
        above = val.above;
        break;
      }
    }
    const total = below + above;
    totalBelow += below;
    totalAbove += above;
    totalVisits += total;

    const achieved = target > 0 ? (sqft / target) * 100 : 0;
    if (target > 0) {
      totalAchievedSum += achieved;
      teamsWithTarget++;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td style="text-align:left;padding-left:10px;">${team}</td>
      <td>${below}</td>
      <td>${above}</td>
      <td>${total}</td>
      <td>${target ? target.toLocaleString("en-IN") : "-"}</td>
      <td>${count}</td>
      <td>${Math.round(sqft).toLocaleString("en-IN")}</td>
      <td>${percent.toFixed(1)}%</td>
      <td>${target ? achieved.toFixed(1) + "%" : "-"}</td>`;
    tbody.appendChild(tr);
  });

  const avgAchieved = teamsWithTarget > 0 ? (totalAchievedSum / teamsWithTarget).toFixed(1) : "-";
  const trTotal = document.createElement("tr");
  trTotal.style.fontWeight = "bold";
  trTotal.style.background = "#fff8dc";
  trTotal.innerHTML = `
    <td colspan="2">Grand Total</td>
    <td>${totalBelow}</td>
    <td>${totalAbove}</td>
    <td>${totalVisits}</td>
    <td>-</td>
    <td>${totalCount}</td>
    <td>${Math.round(totalSqft).toLocaleString("en-IN")}</td>
    <td>100%</td>
    <td>${avgAchieved}%</td>`;
  tbody.appendChild(trTotal);

  renderChart(entries, totalSqft);
}

function renderChart(entries, totalSqft) {
  const labels = entries.map(([team]) => team);
  const data = entries.map(([, obj]) => obj.sqft);
  const ctx = document.getElementById("teamChart").getContext("2d");
  if (teamChartInstance) teamChartInstance.destroy();

  teamChartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Actual TOTAL SQ-FT",
        data,
        backgroundColor: "#f5b301",
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => {
              const sqft = ctx.raw;
              const percent = totalSqft ? (sqft / totalSqft) * 100 : 0;
              return `${sqft.toLocaleString("en-IN")} Sq.ft (${percent.toFixed(1)}%)`;
            }
          }
        }
      }
    }
  });
}
</script>
</body>
</html>
