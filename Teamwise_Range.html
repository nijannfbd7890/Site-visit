<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Teamwise Range - WRM Dashboard</title>

<!-- Script Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body {
  background: #f5f6fa;
  font-family: "Poppins", sans-serif;
  color: #222;
  text-align: center;
  margin: 0;
  padding: 0;
}
header {
  width: 100%;
  background: linear-gradient(90deg, #1e3a8a, #22398a);
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.header-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px 40px;
}
.logo-left, .logo-right {
  height: 60px;
  width: 60px;
  border-radius: 50%;
  background-color: white;
  object-fit: cover;
  border: 2px solid #f5b301;
}
.header-title {
  flex: 1;
  text-align: center;
}
.header-title h1 {
  font-size: 1.8rem;
  line-height: 1.4;
  margin: 0;
  font-weight: 700;
  color: #fff;
}
.header-title span {
  font-size: 1.1rem;
  color: #fdd835;
  font-weight: 600;
}

/* Main wrapper */
.main-wrapper {
  max-width: 1200px;
  margin: 25px auto 40px;
  padding: 25px;
  background: #ffffff;
  border-radius: 18px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.05);
}

/* Filter bar */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-bottom: 25px;
}
.filter-bar select, .filter-bar input {
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 0.95rem;
}
.filter-bar button {
  padding: 8px 16px;
  background: #1e3a8a;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}
.filter-bar button:hover {
  background: #2a4ed0;
}

/* Cards */
.summary-row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 25px;
  justify-content: center;
}
.summary-card {
  min-width: 220px;
  padding: 20px 25px;
  border-radius: 14px;
  background: #f9fafb;
  border: 1px solid #e0e0e0;
  text-align: center;
}
.summary-card h3 {
  margin: 0 0 8px;
  font-size: 1rem;
  color: #1e3a8a;
}
.summary-card p {
  margin: 0;
  font-size: 1.4rem;
  font-weight: 600;
  color: #000;
}
.subcounts {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 5px;
  font-size: 0.95rem;
}
.subcounts span {
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 6px;
}
.subcounts .below {
  background: #ffcccc;
  color: #000;
}
.subcounts .above {
  background: #c9f7c1;
  color: #000;
}

/* Table */
.table-wrapper {
  overflow-x: auto;
  margin-top: 20px;
}
#staffTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #fff;
  color: #000;
  border-radius: 12px;
  overflow: hidden;
}
#staffTable th, #staffTable td {
  border: 1px solid #e0e0e0;
  padding: 8px;
  text-align: center;
}
#staffTable thead tr:first-child th {
  background: #1e3a8a;
  color: #fff;
  font-size: 1rem;
  padding: 10px;
}
#staffTable thead tr:nth-child(2) th {
  background: #f5b301;
  color: #000;
}

/* Alternating row colors for better readability */
#staffTable tbody tr:nth-child(3n+1) {
  background-color: #fff8e1; /* light yellow */
}

#staffTable tbody tr:nth-child(3n+2) {
  background-color: #e3f2fd; /* light blue */
}

#staffTable tbody tr:nth-child(3n+3) {
  background-color: #f1f8e9; /* light green */
}

/* Highlight the Grand Total row */
#staffTable tbody tr:last-child {
  background-color: #fdd835 !important;
  font-weight: 700;
  color: #000;
}

/* Distinct background colors per table section */

/* ðŸŸ¡ Site Visit section */
#staffTable th:nth-child(3),
#staffTable th:nth-child(4),
#staffTable th:nth-child(5),
#staffTable td:nth-child(3),
#staffTable td:nth-child(4),
#staffTable td:nth-child(5) {
  background-color: #fff8e1; /* Light yellow */
}

/* ðŸ”µ Target Sq.ft column */
#staffTable th:nth-child(6),
#staffTable td:nth-child(6) {
  background-color: #e3f2fd; /* Light blue */
}

/* ðŸŸ¢ Overall Booking section */
#staffTable th:nth-child(7),
#staffTable th:nth-child(8),
#staffTable th:nth-child(9),
#staffTable td:nth-child(7),
#staffTable td:nth-child(8),
#staffTable td:nth-child(9) {
  background-color: #f1f8e9; /* Light green */
}
/* ðŸŸ¡ Same color for all three "Site Visit" columns */
#staffTable th:nth-child(3),
#staffTable th:nth-child(4),
#staffTable th:nth-child(5),
#staffTable td:nth-child(3),
#staffTable td:nth-child(4),
#staffTable td:nth-child(5) {
  background-color: #fff8e1 !important; /* light yellow */
}


/* ðŸŸ¨ Grand Total row */
#staffTable tbody tr:last-child {
  background-color: #fdd835 !important;
  font-weight: 700;
  color: #000;
}



/* Chart */
.chart-container {
  margin-top: 30px;
  padding: 15px;
  border-radius: 16px;
  background: #ffffff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  height: 400px;
}
.chart-container h3 {
  margin-bottom: 10px;
}

/* ðŸ”¸ Grand Total row - single color across all columns */
#staffTable tbody tr:last-child td {
  background-color: #fdd835 !important; /* solid yellow */
  font-weight: 700;
  color: #000;
}

</style>
</head>

<body>
<header>
  <div class="header-container">
    <img src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/LOGO.png" class="logo-left" />
    <div class="header-title">
      <h1>
        Namma Family Builder and Developer Pvt. Ltd<br>
        Site Visit Dashboard<br>
        <span>Team - Marketing Management</span>
      </h1>
    </div>
    <img src="https://raw.githubusercontent.com/nijannfbd7890/WRM/main/cs.jpg" class="logo-right" />
  </div>
</header>

<div class="main-wrapper">

  <!-- Filters -->
  <div class="filter-bar">
    <select id="yearFilter">
      <option value="">Select Year</option>
    </select>
    <select id="monthFilter">
      <option value="">Select Month</option>
    </select>
    <input type="date" id="startDate" />
    <input type="date" id="endDate" />
    <button onclick="applyFilters()">Apply Filter</button>
  </div>

  <div class="summary-row">
    <div class="summary-card">
      <h3>Total Site Visits</h3>
      <p id="totalSiteVisits">0</p>
    </div>
    <div class="summary-card">
      <h3>Total Actual TOTAL SQ-FT</h3>
      <p id="totalSqft">0</p>
    </div>
    <div class="summary-card">
      <h3>Total Visits (Above/Below)</h3>
      <p id="totalVisits">0</p>
      <div class="subcounts">
        <span class="below">Below: <span id="belowCount">0</span></span>
        <span class="above">Above: <span id="aboveCount">0</span></span>
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    <table id="staffTable">
      <thead>
        <tr>
          <th colspan="10">Team Wise WRM Achieved (%) Report</th>
        </tr>
        <tr>
          <th rowspan="2">S.No</th>
          <th rowspan="2">Team Name</th>
          <th colspan="3">Site Visit</th>
          <th rowspan="2">Target Sq.ft</th>
          <th colspan="3">Overall Booking</th>
        </tr>
        <tr>
          <th>Below 8</th>
          <th>Above 8</th>
          <th>Total</th>
          <th>Count</th>
          <th>Sqft</th>
          <th>% (Percentage)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-container">
    <h3>Actual TOTAL SQ-FT by TEAM NAME</h3>
    <canvas id="teamChart"></canvas>
  </div>
</div>

<footer>Â© 2025 Namma Family Builder & Developer Pvt. Ltd â€” All Rights Reserved</footer>

<script>
const CSV_MAIN  = "https://nijannfbd7890.github.io/Site-visit/workbook.csv";
const CSV_VISIT = "https://nijannfbd7890.github.io/Site-visit/SITE_VISIT.csv";

let allMainRows  = [];
let allVisitRows = [];
let teamChart = null;

const teamTargets = {
  "Mr.Suriya Sir & Selva Kumar Sir": 15600,
  "Mr.Prabhakaran sir": 7300,
  "Mr.Senthil Sir": 8500,
  "Mr.Ranjith sir": 16500,
  "Mr.Thangadurai Sir": 17100,
  "Mr.Gopi Sir": 3000,
  "Mr.Latha Mam & Ayyappan Sir": 17400,
  "Mr.Rajiv sir": 10100,
  "Mr.Ashok sir": 15100,
  "Mr.Sankar Sir": 5100,
  "Mr.Kumaresan sir": 5700
};

function parseExcelDate(str) {
  if (!str) return null;
  str = String(str).trim();
  if (!str) return null;
  const match = str.match(/^(\d{1,2})[-\s]([A-Za-z]{3,})[-\s](\d{2,4})$/);
  if (match) {
    let [, day, mon, year] = match;
    const months = ["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];
    const mIndex = months.indexOf(mon.toLowerCase());
    if (mIndex >= 0) {
      if (year.length === 2) year = "20" + year;
      return new Date(Number(year), mIndex, Number(day));
    }
  }
  const parsed = new Date(str);
  return isNaN(parsed) ? null : parsed;
}

function normalizeTeamName(name) {
  if (!name) return "";
  let n = String(name).toLowerCase();
  n = n.replace(/[.&]/g, " ");
  n = n.replace(/\b(mr|mrs|sir|madam|mam)\b/g, " ");
  n = n.replace(/&/g, " ");
  let tokens = n.split(/\s+/).filter(t => t.length > 2);
  tokens = Array.from(new Set(tokens));
  tokens.sort();
  return tokens.join(" ");
}

function toNumber(val) {
  if (val === null || val === undefined) return 0;
  if (typeof val === "string") {
    val = val.replace(/,/g, "").replace(/\..*$/, "").trim();
    if (val === "") return 0;
  }
  const num = parseFloat(val);
  return isNaN(num) ? 0 : num;
}

function populateFilters(rows) {
  const dateCol = "DATE";
  const validDates = rows.map(r => parseExcelDate(r[dateCol])).filter(Boolean);
  if (!validDates.length) return;
  const years  = [...new Set(validDates.map(d => d.getFullYear()))].sort();
  const months = [...new Set(validDates.map(d => d.getMonth() + 1))].sort();
  const yearSel  = document.getElementById("yearFilter");
  const monthSel = document.getElementById("monthFilter");
  yearSel.innerHTML  = '<option value="">Select Year</option>';
  monthSel.innerHTML = '<option value="">Select Month</option>';
  years.forEach(y => {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    yearSel.appendChild(opt);
  });
  months.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = new Date(0, m - 1).toLocaleString("default", { month: "long" });
    monthSel.appendChild(opt);
  });
}

function buildTeamReport(mainRows, visitRows) {
  const mainAgg = {};
  mainRows.forEach(r => {
    const key = normalizeTeamName(r["TEAM NAME"]);
    if (!key) return;
    if (!mainAgg[key]) mainAgg[key] = { teamName: (r["TEAM NAME"] || "").trim(), count: 0, sqft: 0 };
    const bucket = mainAgg[key];
    bucket.count += toNumber(r["NO OF PLOTS"] ?? r["Count"]);
    bucket.sqft += toNumber(r["Actual TOTAL SQ-FT"] ?? r["Sqft"]);
  });

  const visitAgg = {};
  visitRows.forEach(r => {
    const key  = normalizeTeamName(r["TEAM NAME"]);
    if (!key) return;
    if (!visitAgg[key]) visitAgg[key] = { teamName: (r["TEAM NAME"] || "").trim(), below: 0, above: 0 };
    const bucket = visitAgg[key];
    const type = String(r["Above /below"] || "").toLowerCase();
    if (type.includes("below")) bucket.below++;
    else if (type.includes("above")) bucket.above++;
  });

  const allKeys = Array.from(new Set([...Object.keys(mainAgg), ...Object.keys(visitAgg)])).sort();
  const tbody = document.querySelector("#staffTable tbody");
  tbody.innerHTML = "";

  let totalBelow=0,totalAbove=0,totalVisits=0,totalTarget=0,totalCount=0,totalSqft=0;

  allKeys.forEach((key,index)=>{
    const main=mainAgg[key]||{teamName:(visitAgg[key]&&visitAgg[key].teamName)||"",count:0,sqft:0};
    const visit=visitAgg[key]||{teamName:main.teamName,below:0,above:0};
    const below=visit.below||0;
    const above=visit.above||0;
    const total=below+above;
    const fixedTarget=teamTargets[main.teamName?.trim()]||teamTargets[visit.teamName?.trim()];
    const targetSqft=fixedTarget?toNumber(fixedTarget):0;
    const count=toNumber(main.count);
    const sqft=toNumber(main.sqft);
    const percentage=targetSqft>0?Math.round((sqft/targetSqft)*100):0;

    totalBelow+=below;
    totalAbove+=above;
    totalVisits+=total;
    totalTarget+=targetSqft;
    totalCount+=count;
    totalSqft+=sqft;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${index+1}</td>
      <td>${main.teamName||visit.teamName||key}</td>
      <td>${below}</td>
      <td>${above}</td>
      <td>${total}</td>
      <td>${Math.round(targetSqft)}</td>
      <td>${Math.round(count)}</td>
      <td>${Math.round(sqft)}</td>
      <td>${percentage}</td>
    `;
    tbody.appendChild(tr);
  });

  const grandRow=document.createElement("tr");
  grandRow.style.fontWeight="bold";
  grandRow.style.backgroundColor="#fdd835";
  grandRow.innerHTML=`
    <td colspan="2" style="text-align:center;">Grand Total</td>
    <td>${totalBelow}</td>
    <td>${totalAbove}</td>
    <td>${totalVisits}</td>
    <td>${totalTarget}</td>
    <td>${totalCount}</td>
    <td>${totalSqft}</td>
    <td></td>
  `;
  tbody.appendChild(grandRow);

  document.getElementById("belowCount").textContent=totalBelow;
  document.getElementById("aboveCount").textContent=totalAbove;
  document.getElementById("totalVisits").textContent=totalVisits;
  document.getElementById("totalSiteVisits").textContent=totalVisits;
  document.getElementById("totalSqft").textContent=totalSqft;
}

function applyFilters(){
  if(!allVisitRows.length||!allMainRows.length)return;
  const year=document.getElementById("yearFilter").value;
  const month=document.getElementById("monthFilter").value;
  const startDate=document.getElementById("startDate").value;
  const endDate=document.getElementById("endDate").value;
  const filter=(rows,col)=>rows.filter(r=>{
    const d=parseExcelDate(r[col]);
    if(!d)return false;
    if(year&&d.getFullYear().toString()!==year)return false;
    if(month&&(d.getMonth()+1).toString()!==month)return false;
    if(startDate&&d<new Date(startDate))return false;
    if(endDate&&d>new Date(endDate))return false;
    return true;
  });
  const filteredMain=filter(allMainRows,"SITE VISIT DATE");
  const filteredVisit=filter(allVisitRows,"DATE");
  buildTeamReport(filteredMain,filteredVisit);
}

Papa.parse(CSV_MAIN,{
  download:true,header:true,skipEmptyLines:true,
  complete:resMain=>{
    allMainRows=resMain.data;
    Papa.parse(CSV_VISIT,{
      download:true,header:true,skipEmptyLines:true,
      complete:resVisit=>{
        allVisitRows=resVisit.data;
        populateFilters(allVisitRows);
        buildTeamReport(allMainRows,allVisitRows);
      }
    });
  }
});
</script>

</body>
</html>
